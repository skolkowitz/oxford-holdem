<!DOCTYPE html>
<html>
<head>
    <title>Oxford Hold 'Em Unit Tests</title>
    <style>
        body { font-family: monospace; background: #121212; color: #eee; padding: 20px; }
        .pass { color: #4CAF50; }
        .fail { color: #ff5252; font-weight: bold; }
        .summary { margin-top: 20px; font-size: 1.2em; border-top: 1px solid #555; padding-top: 10px; }
    </style>
</head>
<body>
    <h1>Unit Tests</h1>
    <div id="results"></div>
    <div id="summary" class="summary"></div>

    <!-- Mock Dependencies if needed -->
    <script>
        // Mock Firebase to avoid errors if code runs
        const firebase = {
            initializeApp: () => {},
            firestore: () => ({ collection: () => ({ doc: () => ({ get: () => Promise.resolve({exists:false}), set: () => Promise.resolve() }) }) }),
            firestore: { FieldValue: { serverTimestamp: () => 'TIMESTAMP' } }
        };
        // Mock Audio
        window.AudioContext = class { createOscillator(){return{connect:()=>{},start:()=>{},stop:()=>{},frequency:{setValueAtTime:()=>{},exponentialRampToValueAtTime:()=>{},linearRampToValueAtTime:()=>{}}};} createGain(){return{gain:{setValueAtTime:()=>{},exponentialRampToValueAtTime:()=>{},linearRampToValueAtTime:()=>{}},connect:()=>{}};} };
    </script>
    
    <!-- Load Game Logic -->
    <script src="firebase-config.js"></script>
    <script src="game.js"></script>

    <script>
        let passed = 0;
        let failed = 0;

        // Helper to create card objects for calculateOptimalScore
        // handChars: array of chars
        // boardChars: array of chars (5th is River)
        // holeMult: multiplier for hand cards
        function makeCards(handChars, boardChars, holeMult = 1) {
            let cards = [];
            handChars.forEach(c => cards.push({ char: c, mult: holeMult }));
            boardChars.forEach((c, i) => {
                let mult = (i === 4) ? 2 : 1; // River is 5th card (index 4)
                cards.push({ char: c, mult: mult });
            });
            return cards;
        }

        function test(name, fn) {
            try {
                fn();
                document.getElementById('results').innerHTML += `<div class="pass">✅ PASS: ${name}</div>`;
                passed++;
            } catch (e) {
                document.getElementById('results').innerHTML += `<div class="fail">❌ FAIL: ${name} - ${e.message}</div>`;
                console.error(e);
                failed++;
            }
        }

        function assert(condition, message) {
            if (!condition) throw new Error(message || "Assertion failed");
        }

        function assertEqual(actual, expected, message) {
            if (actual !== expected) throw new Error(`${message || ''} Expected ${expected}, got ${actual}`);
        }

        // --- TESTS ---
        
        // 1. Scoring Tests (calculateOptimalScore)
        test("Score: Basic Word (CAT)", () => {
            // C=4, A=1, T=1. Total 6.
            const cards = makeCards(['C', 'A', 'T'], ['X', 'Y', 'Z', 'Q', 'J']);
            const score = calculateOptimalScore("CAT", cards);
            assertEqual(score, 6, "CAT should be 6 points");
        });

        test("Score: River Bonus (River is T)", () => {
            // C=4, A=1. T=1. River T (2x) -> T=2. Total 7.
            const cards = makeCards(['C', 'A'], ['X', 'Y', 'Z', 'Q', 'T']);
            const score = calculateOptimalScore("CAT", cards);
            assertEqual(score, 7, "CAT with River T should be 7 points");
        });

        test("Score: Hole Bonus 3x (Feelin' Lucky)", () => {
            // Hand: C (3x). Board: A, T.
            // C=4*3=12. A=1. T=1. Total 14.
            const cards = makeCards(['C'], ['A', 'T', 'X', 'Y', 'Z'], 3);
            const score = calculateOptimalScore("CAT", cards);
            assertEqual(score, 14, "CAT with C(3x) should be 14 points");
        });

        test("Score: Hole Bonus 1.5x (Texas Two Step)", () => {
            // Hand: C (1.5x), A (1.5x). Board: T.
            // C=6. A=1.5. T=1. Total 8.5 -> 8.
            const cards = makeCards(['C', 'A'], ['T', 'X', 'Y', 'Z', 'Q'], 1.5);
            const score = calculateOptimalScore("CAT", cards);
            assertEqual(score, 8, "CAT with C(1.5x), A(1.5x) should be 8 points");
        });

        test("Score: Priority (Hole 3x vs Board 1x)", () => {
            // Hand: A (3x). Board: A (1x).
            const cards = makeCards(['A'], ['A', 'X', 'Y', 'Z', 'Q'], 3);
            const score = calculateOptimalScore("A", cards);
            assertEqual(score, 3, "Should use 3x A instead of 1x A");
        });

        test("Score: Priority (River 2x vs Board 1x)", () => {
            // Board: A (1x) ... A (River 2x).
            const cards = makeCards([], ['A', 'X', 'Y', 'Z', 'A']);
            const score = calculateOptimalScore("A", cards);
            assertEqual(score, 2, "Should use 2x A instead of 1x A");
        });

        test("Score: Length Multiplier (5 letters)", () => {
            // STEAM (S=3, T=1, E=1, A=1, M=5) = 11 base. 1.5x length.
            // 11 * 1.5 = 16.5 -> 16.
            const cards = makeCards(['S', 'T', 'E', 'A', 'M'], ['X', 'Y', 'Z', 'Q', 'J']);
            const score = calculateOptimalScore("STEAM", cards);
            assertEqual(score, 16, "STEAM (5 letters) should be 16 points");
        });

        // 2. Validation Tests
        test("Validation: Missing Letter", () => {
            const cards = makeCards(['C', 'A'], ['X', 'Y', 'Z', 'Q', 'J']); // Missing T
            const score = calculateOptimalScore("CAT", cards);
            assertEqual(score, 0, "Should return 0 if letters missing");
        });

        test("Validation: Wildcard Usage", () => {
            // Hand: C, A, * (1x). * used as T (0 pts).
            // C=4, A=1, *=0. Total 5.
            const cards = makeCards(['C', 'A', '*'], ['X', 'Y', 'Z', 'Q', 'J']);
            const score = calculateOptimalScore("CAT", cards);
            assertEqual(score, 5, "CAT with wildcard should be 5 points");
        });

        // 3. AI Tests
        test("AI: Find Best Word", () => {
            // Setup global variables that findBestPossibleScore uses
            hand = ['C', 'A', 'T'];
            board = ['S', 'B', 'X', 'Y', 'Z']; // River Z
            dictionary = ['CAT', 'CATS', 'CAB'];
            
            // CAT = 6
            // CATS = 6 + 3 = 9
            // CAB = 4+1+7 = 12
            
            const result = findBestPossibleScore();
            assertEqual(result.word, "CAB", "Best word should be CAB");
            assertEqual(result.score, 12, "Best score should be 12");
        });

        test("AI: Go Bust (No words possible)", () => {
            // Setup global variables
            hand = ['Q', 'Q', 'Q'];
            board = ['Z', 'Z', 'Z', 'Z', 'Z']; 
            dictionary = ['CAT', 'DOG', 'FISH'];
            
            const result = findBestPossibleScore();
            assertEqual(result.word, "NONE", "Best word should be NONE");
            assertEqual(result.score, 0, "Best score should be 0");
        });

        // Summary
        document.getElementById('summary').innerText = `Total: ${passed+failed}, Passed: ${passed}, Failed: ${failed}`;
        document.getElementById('summary').style.color = failed > 0 ? '#ff5252' : '#4CAF50';

    </script>
</body>
</html>